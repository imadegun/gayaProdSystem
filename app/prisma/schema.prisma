// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Material and tool tables (migrated from MySQL)
model Tblcasting {
  id                Int      @id @default(autoincrement())
  castingCode       String   @unique @map("CastingCode")
  castingDescription String  @map("CastingDescription")
  castingDate       DateTime @map("CastingDate")
  castingTechDraw   String?  @map("CastingTechDraw")
  castingPhoto1     String?  @map("CastingPhoto1")
  castingPhoto2     String?  @map("CastingPhoto2")
  castingPhoto3     String?  @map("CastingPhoto3")
  castingPhoto4     String?  @map("CastingPhoto4")
  castingNotes      String?  @map("CastingNotes")
  unitCost          Float?   @map("unit_cost") // Cost per use
  costUnit          String?  @default("USE") @map("cost_unit")

  // Relations
  productCastings    ProductCasting[]

  @@map("tblcasting")
}

model Tblclay {
  id                Int      @id @default(autoincrement())
  clayCode          String   @unique @map("ClayCode")
  clayDescription   String   @map("ClayDescription")
  clayDate          DateTime @map("ClayDate")
  clayTechDraw      String?  @map("ClayTechDraw")
  clayPhoto1        String?  @map("ClayPhoto1")
  clayPhoto2        String?  @map("ClayPhoto2")
  clayPhoto3        String?  @map("ClayPhoto3")
  clayPhoto4        String?  @map("ClayPhoto4")
  clayNotes         String?  @map("ClayNotes")
  unitCost          Float?   @map("unit_cost") // Cost per KG
  costUnit          String?  @default("KG") @map("cost_unit")

  // Relations
  productClays      ProductClay[]

  @@map("tblclay")
}

model Tblengobe {
  id                Int      @id @default(autoincrement())
  engobeCode        String   @unique @map("EngobeCode")
  engobeDescription String   @map("EngobeDescription")
  engobeDate        DateTime @map("EngobeDate")
  engobeTechDraw    String?  @map("EngobeTechDraw")
  engobePhoto1      String?  @map("EngobePhoto1")
  engobePhoto2      String?  @map("EngobePhoto2")
  engobePhoto3      String?  @map("EngobePhoto3")
  engobePhoto4      String?  @map("EngobePhoto4")
  engobeNotes       String?  @map("EngobeNotes")
  unitCost          Float?   @map("unit_cost") // Cost per KG
  costUnit          String?  @default("KG") @map("cost_unit")

  // Relations
  productEngobes    ProductEngobe[]

  @@map("tblengobe")
}

model Tblestruder {
  id                Int      @id @default(autoincrement())
  estruderCode      String   @unique @map("EstruderCode")
  estruderDescription String @map("EstruderDescription")
  estruderDate      DateTime @map("EstruderDate")
  estruderTechDraw  String?  @map("EstruderTechDraw")
  estruderPhoto1    String?  @map("EstruderPhoto1")
  estruderPhoto2    String?  @map("EstruderPhoto2")
  estruderPhoto3    String?  @map("EstruderPhoto3")
  estruderPhoto4    String?  @map("EstruderPhoto4")
  estruderNotes     String?  @map("EstruderNotes")
  unitCost          Float?   @map("unit_cost") // Cost per use
  costUnit          String?  @default("USE") @map("cost_unit")

  // Relations
  productEstruders  ProductEstruder[]

  @@map("tblestruder")
}

model Tblglaze {
  id                Int      @id @default(autoincrement())
  glazeCode         String   @unique @map("GlazeCode")
  glazeDescription  String   @map("GlazeDescription")
  glazeDate         DateTime @map("GlazeDate")
  glazeTechDraw     String?  @map("GlazeTechDraw")
  glazePhoto1       String?  @map("GlazePhoto1")
  glazePhoto2       String?  @map("GlazePhoto2")
  glazePhoto3       String?  @map("GlazePhoto3")
  glazePhoto4       String?  @map("GlazePhoto4")
  glazeNotes        String?  @map("GlazeNotes")
  unitCost          Float?   @map("unit_cost") // Cost per KG
  costUnit          String?  @default("KG") @map("cost_unit")

  // Relations
  productGlazes     ProductGlaze[]

  @@map("tblglaze")
}

model Tbllustre {
  id                Int      @id @default(autoincrement())
  lustreCode        String   @unique @map("LustreCode")
  lustreDescription String   @map("LustreDescription")
  lustreDate        DateTime @map("LustreDate")
  lustreTechDraw    String?  @map("LustreTechDraw")
  lustrePhoto1      String?  @map("LustrePhoto1")
  lustrePhoto2      String?  @map("LustrePhoto2")
  lustrePhoto3      String?  @map("LustrePhoto3")
  lustrePhoto4      String?  @map("LustrePhoto4")
  lustreNotes       String?  @map("LustreNotes")
  unitCost          Float?   @map("unit_cost") // Cost per KG
  costUnit          String?  @default("KG") @map("cost_unit")

  // Relations
  productLustres    ProductLustre[]

  @@map("tbllustre")
}

model Tblstainoxide {
  id                Int      @id @default(autoincrement())
  stainOxideCode    String   @unique @map("StainOxideCode")
  stainOxideDescription String @map("StainOxideDescription")
  stainOxideDate    DateTime @map("StainOxideDate")
  stainOxideTechDraw String? @map("StainOxideTechDraw")
  stainOxidePhoto1  String?  @map("StainOxidePhoto1")
  stainOxidePhoto2  String?  @map("StainOxidePhoto2")
  stainOxidePhoto3  String?  @map("StainOxidePhoto3")
  stainOxidePhoto4  String?  @map("StainOxidePhoto4")
  stainOxideNotes   String?  @map("StainOxideNotes")
  unitCost          Float?   @map("unit_cost") // Cost per KG
  costUnit          String?  @default("KG") @map("cost_unit")

  // Relations
  productStainOxides ProductStainOxide[]

  @@map("tblstainoxide")
}

model Tbltexture {
  id                Int      @id @default(autoincrement())
  textureCode       String   @unique @map("TextureCode")
  textureDescription String  @map("TextureDescription")
  textureDate       DateTime @map("TextureDate")
  textureTechDraw   String?  @map("TextureTechDraw")
  texturePhoto1     String?  @map("TexturePhoto1")
  texturePhoto2     String?  @map("TexturePhoto2")
  texturePhoto3     String?  @map("TexturePhoto3")
  texturePhoto4     String?  @map("TexturePhoto4")
  textureNotes      String?  @map("TextureNotes")
  unitCost          Float?   @map("unit_cost") // Cost per KG or per use
  costUnit          String?  @default("KG") @map("cost_unit")

  // Relations
  productTextures   ProductTexture[]

  @@map("tbltexture")
}

model Tbltools {
  id                Int      @id @default(autoincrement())
  toolsCode         String   @unique @map("ToolsCode")
  toolsDescription  String   @map("ToolsDescription")
  toolsDate         DateTime @map("ToolsDate")
  toolsTechDraw     String?  @map("ToolsTechDraw")
  toolsPhoto1       String?  @map("ToolsPhoto1")
  toolsPhoto2       String?  @map("ToolsPhoto2")
  toolsPhoto3       String?  @map("ToolsPhoto3")
  toolsPhoto4       String?  @map("ToolsPhoto4")
  toolsNotes        String?  @map("ToolsNotes")
  unitCost          Float?   @map("unit_cost") // Cost per use or per piece
  costUnit          String?  @default("USE") @map("cost_unit")

  // Relations
  productTools      ProductTools[]

  @@map("tbltools")
}

// Junction tables for product-material relationships (one-to-many migration)
model ProductClay {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  clayId      Int      @map("clay_id")
  sequence    Int?     // 1-4 for legacy compatibility
  quantity    Float?   // KG used
  notes       String?  @map("clay_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  clay        Tblclay          @relation(fields: [clayId], references: [id])

  @@unique([collectCode, clayId])
  @@map("product_clays")
}

model ProductCasting {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  castingId   Int      @map("casting_id")
  sequence    Int?     // 1-4 for legacy compatibility
  notes       String?  @map("casting_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  casting     Tblcasting       @relation(fields: [castingId], references: [id])

  @@unique([collectCode, castingId])
  @@map("product_castings")
}

model ProductEstruder {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  estruderId  Int      @map("estruder_id")
  sequence    Int?     // 1-4 for legacy compatibility
  notes       String?  @map("estruder_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  estruder    Tblestruder      @relation(fields: [estruderId], references: [id])

  @@unique([collectCode, estruderId])
  @@map("product_estruders")
}

model ProductTexture {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  textureId   Int      @map("texture_id")
  sequence    Int?     // 1-4 for legacy compatibility
  notes       String?  @map("texture_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  texture     Tbltexture       @relation(fields: [textureId], references: [id])

  @@unique([collectCode, textureId])
  @@map("product_textures")
}

model ProductTools {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  toolsId     Int      @map("tools_id")
  sequence    Int?     // 1-4 for legacy compatibility
  notes       String?  @map("tools_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  tools       Tbltools         @relation(fields: [toolsId], references: [id])

  @@unique([collectCode, toolsId])
  @@map("product_tools")
}

model ProductEngobe {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  engobeId    Int      @map("engobe_id")
  sequence    Int?     // 1-4 for legacy compatibility
  notes       String?  @map("engobe_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  engobe      Tblengobe        @relation(fields: [engobeId], references: [id])

  @@unique([collectCode, engobeId])
  @@map("product_engobes")
}

model ProductStainOxide {
  id            Int      @id @default(autoincrement())
  collectCode   String   @map("collect_code")
  stainOxideId  Int      @map("stain_oxide_id")
  sequence      Int?     // 1-4 for legacy compatibility
  notes         String?  @map("stain_oxide_note")
  createdAt     DateTime @default(now()) @map("created_at")

  product       TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  stainOxide    Tblstainoxide    @relation(fields: [stainOxideId], references: [id])

  @@unique([collectCode, stainOxideId])
  @@map("product_stain_oxides")
}

model ProductLustre {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  lustreId    Int      @map("lustre_id")
  sequence    Int?     // 1-4 for legacy compatibility
  notes       String?  @map("lustre_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  lustre      Tbllustre        @relation(fields: [lustreId], references: [id])

  @@unique([collectCode, lustreId])
  @@map("product_lustres")
}

model ProductGlaze {
  id          Int      @id @default(autoincrement())
  collectCode String   @map("collect_code")
  glazeId     Int      @map("glaze_id")
  sequence    Int?     // 1-4 for legacy compatibility
  density     String?  @map("glaze_density") // Density value for this glaze
  notes       String?  @map("glaze_note")
  createdAt   DateTime @default(now()) @map("created_at")

  product     TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  glaze       Tblglaze         @relation(fields: [glazeId], references: [id])

  @@unique([collectCode, glazeId])
  @@map("product_glazes")
}

// Existing migrated tables
model TblcollectMaster {
  id                Int      @id @default(autoincrement())
  collectCode       String   @unique @map("collect_code") // Master product code
  assemblyCode      String?  @map("assembly_code") // Assembly product code for sets and non-ceramic materials
  designCode        String?  @map("design_code")
  nameCode          String?  @map("name_code")
  categoryCode      String?  @map("category_code")
  sizeCode          String?  @map("size_code")
  textureCode       String?  @map("texture_code")
  colorCode         String?  @map("color_code")
  materialCode      String?  @map("material_code")
  clientCode        String?  @map("client_code")
  clientDescription String?  @map("client_description")
  collectionType    String?  @map("collection_type") // Exclusive, Exclusive-Group, General
  collectDate       DateTime? @map("collect_date")
  techDraw          String?  @map("tech_draw")
  photo1            String?  @map("photo1")
  photo2            String?  @map("photo2")
  photo3            String?  @map("photo3")
  photo4            String?  @map("photo4")
  isAssembly        Boolean  @default(false) @map("is_assembly") // Indicates if this is an assembly/set product
  assemblyComponents Json?   @map("assembly_components") // JSON array of component product codes
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  category          TblcollectCategory? @relation(fields: [categoryCode], references: [categoryCode])
  color             TblcollectColor?    @relation(fields: [colorCode], references: [colorCode])
  client            Client?             @relation(fields: [designCode], references: [clientCode])
  material          TblcollectMaterial? @relation(fields: [materialCode], references: [materialCode])
  name              TblcollectName?     @relation(fields: [nameCode], references: [nameCode])
  size              TblcollectSize?     @relation(fields: [sizeCode], references: [sizeCode])
  texture           TblcollectTexture?  @relation(fields: [textureCode], references: [textureCode])

  // Material relations (flexible one-to-many)
  productClays      ProductClay[]
  productCastings   ProductCasting[]
  productEstruders  ProductEstruder[]
  productTextures   ProductTexture[]
  productTools      ProductTools[]
  productEngobes    ProductEngobe[]
  productStainOxides ProductStainOxide[]
  productLustres    ProductLustre[]
  productGlazes     ProductGlaze[]

  // Production relations
  workPlanAssignments WorkPlanAssignment[]

  @@map("tblcollect_master")
}

// Reference tables (migrated)
model TblcollectCategory {
  categoryCode    String @id @map("category_code")
  categoryName    String @map("category_name")

  products        TblcollectMaster[]
  @@map("tblcollect_category")
}

model TblcollectColor {
  colorCode    String @id @map("color_code")
  colorName    String @map("color_name")

  products     TblcollectMaster[]
  @@map("tblcollect_color")
}

model Client {
  clientCode      String @id @map("design_code")
  clientDescription String @map("design_name")
  region          String?
  department      String?
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  isActive        Boolean @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  products        TblcollectMaster[]
  purchaseOrders  PurchaseOrder[]
  rndProjects     RnDProject[]

  @@map("tblcollect_design")
}

model TblcollectMaterial {
  materialCode    String @id @map("material_code")
  materialName    String @map("material_name")

  products        TblcollectMaster[]
  @@map("tblcollect_material")
}

model TblcollectName {
  nameCode    String @id @map("name_code")
  nameValue   String @map("name_value")

  products    TblcollectMaster[]
  @@map("tblcollect_name")
}

model TblcollectSize {
  sizeCode    String @id @map("size_code")
  sizeName    String @map("size_name")

  products    TblcollectMaster[]
  @@map("tblcollect_size")
}

model TblcollectTexture {
  textureCode    String @id @map("texture_code")
  textureName    String @map("texture_name")

  products       TblcollectMaster[]
  @@map("tblcollect_texture")
}

// New production tracking tables
model User {
  id            Int       @id @default(autoincrement())
  username      String    @unique
  passwordHash  String    @map("password_hash")
  email         String?
  role          String    // R&D, Sales, Forming, Glaze, QC, Admin
  subRole       String?   @map("sub_role")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  employees     Employee[]
  purchaseOrders PurchaseOrder[] @relation("CreatedBy")
  workPlans     WorkPlan[] @relation("CreatedBy")
  productionRecaps ProductionRecap[] @relation("RecordedBy")
  qcResults     QcResult[] @relation("InspectedBy")
  revisionTickets RevisionTicket[] @relation("SubmittedBy")
  approvedTickets RevisionTicket[] @relation("ApprovedBy")
  systemLogs    SystemLog[]
  performanceAssessments PerformanceAssessment[] @relation("AssessedBy")
  attendanceRecords AttendanceRecord[] @relation("RecordedBy")
  rndProjects   RnDProject[] @relation("RnDCreatedBy")
  quotations    Quotation[]  @relation("QuotationCreatedBy")
  proformas     Proforma[]   @relation("ProformaCreatedBy")
  estimates     Estimate[]   @relation("EstimateCreatedBy")
  purchaseOrderStatusHistory PurchaseOrderStatusHistory[]
}

model Employee {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  employeeCode String @unique @map("employee_code")
  firstName  String   @map("first_name")
  lastName   String   @map("last_name")
  photoUrl   String?  @map("photo_url")
  department String?
  position   String?
  hireDate   DateTime? @map("hire_date")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")

  user       User     @relation(fields: [userId], references: [id])
  workPlanAssignments WorkPlanAssignment[]
  performanceAssessments PerformanceAssessment[]
  attendanceRecords AttendanceRecord[]
}


model PurchaseOrder {
  id              Int       @id @default(autoincrement())
  poNumber        String    @unique @map("po_number")
  proformaId      Int?      @map("proforma_id")
  clientId        String    @map("client_id")
  orderDate         DateTime  @map("order_date")
  depositPercentage Float?    @default(30.0) @map("deposit_percentage") // Default 30% deposit requirement
  depositAmount     Float?    @map("deposit_amount")
  depositPaid       Boolean   @default(false) @map("deposit_paid")
  depositPaidDate   DateTime? @map("deposit_paid_date")
  totalAmount       Float?    @map("total_amount")
  status          PurchaseOrderStatus @default(pending_deposit) @map("status")
  shippingDate    DateTime? @map("shipping_date")
  trackingNumber  String?   @map("tracking_number")
  deliveryDate    DateTime? @map("delivery_date")
  notes           String?
  createdBy       Int       @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  proforma        Proforma? @relation(fields: [proformaId], references: [id])
  client          Client    @relation(fields: [clientId], references: [clientCode])
  creator         User      @relation("CreatedBy", fields: [createdBy], references: [id])
  items           PurchaseOrderItem[]
  productionStages ProductionStage[]
  payments        Payment[]
  statusHistory   PurchaseOrderStatusHistory[]
}

model PurchaseOrderItem {
  id              Int       @id @default(autoincrement())
  purchaseOrderId Int       @map("purchase_order_id")
  directoryListId Int       @map("directory_list_id")
  collectCode     String?   @map("collect_code")
  quantity        Int       @map("quantity")
  unitPrice       Float?    @map("unit_price")
  totalPrice      Float?    @map("total_price")
  deliveryDate    DateTime? @map("delivery_date")
  notes           String?   @map("notes")
  createdAt       DateTime  @default(now()) @map("created_at")

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  directoryList   DirectoryList @relation(fields: [directoryListId], references: [id])

  @@map("purchase_order_items")
}

model ProductionStage {
  id              Int       @id @default(autoincrement())
  name            String    // Forming, Glaze, QC & Packaging
  code            String    @unique
  sequenceOrder   Int       @map("sequence_order")
  description     String?
  isActive        Boolean   @default(true) @map("is_active")
  laborCostPerHour Float?   @map("labor_cost_per_hour") // Cost per hour for this stage

  workPlanAssignments WorkPlanAssignment[]
  purchaseOrders PurchaseOrder[]
}

model WorkPlan {
  id          Int      @id @default(autoincrement())
  weekStart   DateTime @map("week_start")
  weekEnd     DateTime @map("week_end")
  planType    String   @default("production") @map("plan_type") // production, overtime
  printed     Boolean  @default(false)
  printedDate DateTime? @map("printed_date")
  createdBy   Int      @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  creator     User     @relation("CreatedBy", fields: [createdBy], references: [id])
  assignments WorkPlanAssignment[]
}

model WorkPlanAssignment {
  id              Int      @id @default(autoincrement())
  workPlanId      Int      @map("work_plan_id")
  employeeId      Int      @map("employee_id")
  productionStageId Int    @map("production_stage_id")
  collectCode     String   @map("collect_code")
  plannedQuantity Int      @map("planned_quantity")
  targetQuantity  Int?     @map("target_quantity")
  processName     String?  @map("process_name")
  dayOfWeek       Int      @map("day_of_week") // 1=Monday, 7=Sunday
  isOvertime      Boolean  @default(false) @map("is_overtime")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")

  workPlan        WorkPlan        @relation(fields: [workPlanId], references: [id])
  employee        Employee        @relation(fields: [employeeId], references: [id])
  productionStage ProductionStage @relation(fields: [productionStageId], references: [id])
  product         TblcollectMaster @relation(fields: [collectCode], references: [collectCode])
  productionRecaps ProductionRecap[]
}

model ProductionRecap {
  id                    Int       @id @default(autoincrement())
  workPlanAssignmentId  Int       @map("work_plan_assignment_id")
  recapDate             DateTime  @map("recap_date")
  actualQuantity        Int       @map("actual_quantity")
  goodQuantity          Int?
  rejectQuantity        Int       @default(0) @map("reject_quantity")
  reFireQuantity        Int       @default(0) @map("re_fire_quantity")
  secondQualityQuantity Int       @default(0) @map("second_quality_quantity")
  notes                 String?
  recordedBy            Int       @map("recorded_by")
  recordedAt            DateTime  @default(now()) @map("recorded_at")

  workPlanAssignment    WorkPlanAssignment @relation(fields: [workPlanAssignmentId], references: [id])
  recorder              User                @relation("RecordedBy", fields: [recordedBy], references: [id])
  qcResults             QcResult[]
}

model QcResult {
  id                    Int       @id @default(autoincrement())
  productionRecapsId    Int       @map("production_recaps_id")
  poNumber              String?   @map("po_number")
  collectCode           String    @map("collect_code")
  qcStage               String    @map("qc_stage") // loading_firing_high, loading_firing_luster
  goodQuantity          Int       @default(0) @map("good_quantity")
  reFireQuantity        Int       @default(0) @map("re_fire_quantity")
  rejectQuantity        Int       @default(0) @map("reject_quantity")
  secondQualityQuantity Int       @default(0) @map("second_quality_quantity")
  qcNotes               String?   @map("qc_notes")
  inspectedBy           Int       @map("inspected_by")
  inspectedAt           DateTime  @default(now()) @map("inspected_at")

  productionRecap       ProductionRecap @relation(fields: [productionRecapsId], references: [id])
  inspector             User            @relation("InspectedBy", fields: [inspectedBy], references: [id])
  stockItems            StockItem[]
}

model StockItem {
  id                    Int       @id @default(autoincrement())
  qcResultId            Int       @map("qc_result_id")
  collectCode           String    @map("collect_code")
  poNumber              String?   @map("po_number")
  quantity              Int
  grade                 String    @map("grade") // 1st, 2nd
  unitCost              Float?    @map("unit_cost")
  sellingPrice          Float?    @map("selling_price")
  status                String    @default("available") @map("status") // available, reserved, sold
  location              String?
  notes                 String?
  createdAt             DateTime  @default(now()) @map("created_at")

  qcResult              QcResult  @relation(fields: [qcResultId], references: [id])
}

model RevisionTicket {
  id            Int       @id @default(autoincrement())
  ticketNumber  String    @unique @map("ticket_number")
  poNumber      String?   @map("po_number")
  collectCode   String    @map("collect_code")
  title         String
  purpose       String?
  explanation   String?
  status        String    @default("pending") @map("status") // pending, approved, rejected, implemented
  attachments   Json?     @map("attachments") // Array of file URLs
  submittedBy   Int       @map("submitted_by")
  approvedBy    Int?      @map("approved_by")
  approvedAt    DateTime? @map("approved_at")
  implementedAt DateTime? @map("implemented_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  submitter     User      @relation("SubmittedBy", fields: [submittedBy], references: [id])
  approver      User?     @relation("ApprovedBy", fields: [approvedBy], references: [id])
}

model SystemLog {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  action      String
  entityType  String?  @map("entity_type") // table name or module
  entityId    Int?
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User?    @relation(fields: [userId], references: [id])
}

model PerformanceAssessment {
  id                Int      @id @default(autoincrement())
  employeeId        Int      @map("employee_id")
  assessmentDate    DateTime @map("assessment_date")
  periodStart       DateTime? @map("period_start")
  periodEnd         DateTime? @map("period_end")
  plusPoints        Int      @default(0) @map("plus_points")
  minusPoints       Int      @default(0) @map("minus_points")
  assessmentNotes   String?  @map("assessment_notes")
  assessedBy        Int      @map("assessed_by")
  createdAt         DateTime @default(now()) @map("created_at")

  employee          Employee @relation(fields: [employeeId], references: [id])
  assessor          User     @relation("AssessedBy", fields: [assessedBy], references: [id])
}

model AttendanceRecord {
  id            Int      @id @default(autoincrement())
  employeeId    Int      @map("employee_id")
  recordDate    DateTime @map("record_date")
  checkInTime   DateTime? @map("check_in_time")
  checkOutTime  DateTime? @map("check_out_time")
  hoursWorked   Float?   @map("hours_worked")
  status        String   @default("present") @map("status") // present, absent, late, half_day
  notes         String?
  recordedBy    Int      @map("recorded_by")
  createdAt     DateTime @default(now()) @map("created_at")

  employee      Employee @relation(fields: [employeeId], references: [id])
  recorder      User     @relation("RecordedBy", fields: [recordedBy], references: [id])
}

// R&D Project Management
model RnDProject {
  id          Int      @id @default(autoincrement())
  clientId    String   @map("client_id")
  projectName String   @map("project_name")
  description String?
  status      String   @default("draft_directory") @map("status") // draft_directory, estimate_created, quotation_sent, quotation_approved, sample_development, sample_completed, proforma_created, client_approved, client_revised, cancelled
  workflowStep String? @map("workflow_step") // Current step in workflow
  createdBy   Int      @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  client      Client   @relation(fields: [clientId], references: [clientCode])
  creator     User     @relation("RnDCreatedBy", fields: [createdBy], references: [id])
  directoryLists DirectoryList[]
  estimates    Estimate[]
  quotations   Quotation[]
  samples      Sample[]
  proformas    Proforma[]
}

// Pricing and Currency Support
model Currency {
  id          Int      @id @default(autoincrement())
  code        String   @unique @map("code") // USD, EUR, IDR, etc.
  name        String   @map("name")
  symbol      String   @map("symbol") // $, â‚¬, Rp, etc.
  exchangeRate Float   @default(1.0) @map("exchange_rate") // Rate to base currency
  isBase      Boolean  @default(false) @map("is_base") // Base currency flag
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  quotations  Quotation[]
  proformas   Proforma[]
  estimates   Estimate[]

  @@map("currencies")
}

model PricingFormula {
  id              Int      @id @default(autoincrement())
  name            String   @map("name")
  description     String?  @map("description")
  formulaType     String   @map("formula_type") // material_factor, difficulty_level, firing_type, glaze_level
  parameters      Json     @map("parameters") // Formula parameters and calculations
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("pricing_formulas")
}

// Sample Development Workflow Tables
// Estimate List - Draft directory list sent to client
model Estimate {
  id            Int      @id @default(autoincrement())
  projectId     Int      @map("project_id")
  estimateNumber String  @unique @map("estimate_number")
  directoryListId Int    @map("directory_list_id")
  title         String   @map("title")
  description   String?  @map("description")
  totalAmount   Float?   @map("total_amount")
  currencyId    Int?     @map("currency_id")
  status        String   @default("draft") @map("status") // draft, sent, approved, rejected, revised
  sentDate      DateTime? @map("sent_date")
  responseDate  DateTime? @map("response_date")
  clientResponse String? @map("client_response") // ok_all, ok_selected, revised, cancelled
  notes         String?  @map("notes")
  attachments   Json?    @map("attachments") // Array of file URLs
  createdBy     Int      @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  project       RnDProject @relation(fields: [projectId], references: [id])
  directoryList DirectoryList @relation(fields: [directoryListId], references: [id])
  currency      Currency? @relation(fields: [currencyId], references: [id])
  creator       User      @relation("EstimateCreatedBy", fields: [createdBy], references: [id])

  @@map("estimates")
}
model DirectoryList {
  id              Int      @id @default(autoincrement())
  projectId       Int      @map("project_id")
  revisionNumber  Int      @default(1) @map("revision_number")
  parentId        Int?     @map("parent_id") // For revision tracking
  itemName        String   @map("item_name")
  itemCode        String?  @map("item_code") // New field for item code
  description     String?  @map("description")
  collectCode     String?  @map("collect_code") // Reference to TblcollectMaster
  quantity        Int      @default(1) @map("quantity")
  status          String   @default("draft") @map("status") // draft, approved, rejected
  // Enhanced item properties
  photos          Json?    @map("photos") // Array of photo URLs
  textureName     String?  @map("texture_name")
  colorName       String?  @map("color_name")
  materialName    String?  @map("material_name")
  sizeInfo        String?  @map("size_info") // Size information
  // Technical specifications
  clay            String?  @map("clay")
  glaze           String?  @map("glaze")
  texture         String?  @map("texture")
  engobe          String?  @map("engobe")
  firingType      String?  @map("firing_type")
  luster          String?  @map("luster")
  dimensions      Json?    @map("dimensions") // Width, Height, Length, Diameter
  weight          Float?   @map("weight")
  notes           String?  @map("notes")
  // Set/Breakdown model support
  isSet           Boolean  @default(false) @map("is_set") // Indicates if this is a set/breakdown item
  components      Json?    @map("components") // Array of component items for sets
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  project         RnDProject @relation(fields: [projectId], references: [id])
  parent          DirectoryList? @relation("DirectoryRevisions", fields: [parentId], references: [id])
  revisions       DirectoryList[] @relation("DirectoryRevisions")
  estimates       Estimate[]
  quotations      Quotation[]
  samples         Sample[]
  proformas       Proforma[]
  purchaseOrderItems PurchaseOrderItem[]

  @@map("directory_lists")
}

model Quotation {
  id            Int      @id @default(autoincrement())
  projectId     Int      @map("project_id")
  quotationNumber String @unique @map("quotation_number")
  directoryListId Int?   @map("directory_list_id")
  title         String   @map("title")
  description   String?  @map("description")
  totalAmount   Float?   @map("total_amount")
  currencyId    Int?     @map("currency_id")
  status        String   @default("draft") @map("status") // draft, sent, approved, rejected, revised
  sentDate      DateTime? @map("sent_date")
  responseDate  DateTime? @map("response_date")
  clientResponse String? @map("client_response") // ok_all, ok_selected, revised, cancelled
  notes         String?  @map("notes")
  attachments   Json?    @map("attachments") // Array of file URLs
  createdBy     Int      @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  project       RnDProject @relation(fields: [projectId], references: [id])
  directoryList DirectoryList? @relation(fields: [directoryListId], references: [id])
  currency      Currency? @relation(fields: [currencyId], references: [id])
  creator       User      @relation("QuotationCreatedBy", fields: [createdBy], references: [id])

  @@map("quotations")
}

model Sample {
  id            Int      @id @default(autoincrement())
  projectId     Int      @map("project_id")
  directoryListId Int    @map("directory_list_id")
  sampleCode    String   @unique @map("sample_code")
  status        String   @default("pending") @map("status") // pending, in_progress, completed, rejected
  startDate     DateTime? @map("start_date")
  completionDate DateTime? @map("completion_date")
  quantity      Int      @default(1) @map("quantity")
  notes         String?  @map("notes")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  project       RnDProject @relation(fields: [projectId], references: [id])
  directoryList DirectoryList @relation(fields: [directoryListId], references: [id])

  @@map("samples")
}

model Proforma {
  id            Int      @id @default(autoincrement())
  projectId     Int      @map("project_id")
  proformaNumber String  @unique @map("proforma_number")
  directoryListId Int?   @map("directory_list_id")
  title         String   @map("title")
  description   String?  @map("description")
  totalAmount   Float?   @map("total_amount")
  currencyId    Int?     @map("currency_id")
  status        String   @default("draft") @map("status") // draft, sent, approved, rejected
  sentDate      DateTime? @map("sent_date")
  responseDate  DateTime? @map("response_date")
  clientResponse String? @map("client_response") // ok_all, ok_selected, revised, cancelled
  selectedItems Json?    @map("selected_items") // Array of approved directory item IDs
  pricingDetails Json?   @map("pricing_details") // Cost breakdown for transparency
  notes         String?  @map("notes")
  attachments   Json?    @map("attachments") // Array of file URLs
  createdBy     Int      @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  project       RnDProject @relation(fields: [projectId], references: [id])
  directoryList DirectoryList? @relation(fields: [directoryListId], references: [id])
  currency      Currency? @relation(fields: [currencyId], references: [id])
  creator       User      @relation("ProformaCreatedBy", fields: [createdBy], references: [id])
  purchaseOrders PurchaseOrder[]

  @@map("proformas")
}

enum PurchaseOrderStatus {
  pending_deposit
  deposit_received
  in_production
  qc_completed
  packaging
  shipped
  delivered
  cancelled
}

model PurchaseOrderStatusHistory {
  id              Int       @id @default(autoincrement())
  purchaseOrderId Int       @map("purchase_order_id")
  oldStatus       PurchaseOrderStatus? @map("old_status")
  newStatus       PurchaseOrderStatus  @map("new_status")
  changedBy       Int       @map("changed_by") // User ID who made the change
  changeReason    String?   @map("change_reason") // Reason for status change
  notes           String?   @map("notes")
  createdAt       DateTime  @default(now()) @map("created_at")

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  user            User          @relation(fields: [changedBy], references: [id])

  @@map("purchase_order_status_history")
}

model Payment {
  id                Int       @id @default(autoincrement())
  purchaseOrderId   Int       @map("purchase_order_id")
  amount            Float     @map("amount")
  depositPercentage Float?    @map("deposit_percentage") // e.g., 30.0 for 30%
  status            String    @default("pending") @map("status") // pending, paid, overdue, refunded
  paymentMethod     String?   @map("payment_method") // bank_transfer, cash, check, etc.
  paymentDate       DateTime? @map("payment_date")
  dueDate           DateTime? @map("due_date")
  notes             String?   @map("notes")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@map("payments")
}
